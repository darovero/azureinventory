trigger:
- none

pool:
  vmImage: 'windows-latest'

parameters:
- name: resourcegroup
  displayName: 'Resource Group Name'
  type: string
- name: environment
  displayName: 'Environment'
  type: string
  values:
  - 'Non-Prod'
  - 'Prod'
- name: tagsToFilter
  displayName: 'Tags to Filter'
  type: string
  default: 'owner,deploymentid'
- name: ContainerFolder
  default: "Inventory"

variables:
  - group: ${{ parameters.environment }}

steps:
- template: Modules/azurepowershell.yaml

- task: AzureCLI@2
  displayName: 'Generating RG Inventory'
  inputs:
    azureSubscription: $(azureSubscription)
    scriptPath: '$(Build.SourcesDirectory)/Scripts/az_inventory.ps1'
    scriptArguments: '-resourceGroup "${{parameters.resourcegroup}}" -tagsToFilter "${{parameters.tagsToFilter}}" -outputFilePath "Resources_${{parameters.resourcegroup}}.csv"'
    scriptType: 'ps'


# - task: AzurePowerShell@5
#   displayName: 'Upload Inventory to Azure Blob Storage'
#   inputs:
#     azureSubscription: $(azureSubscription)
#     ScriptType: 'InlineScript'
#     Inline: |
#       $sourceFilePath = 'Resources_${{parameters.resourcegroup}}.csv'
#       $destinationBlobName = '${{parameters.ContainerFolder}}/Resources_${{parameters.resourcegroup}}.csv'
      
#       $storageContext = New-AzStorageContext -StorageAccountName $(storageAccountName) -StorageAccountKey $(storageAccountAccessKey)
#       $blob = Set-AzStorageBlobContent -Context $storageContext -Container $(storageContainerName) -File $sourceFilePath -Blob $destinationBlobName -Force

#     azurePowerShellVersion: LatestVersion

- task: AzurePowerShell@5
  displayName: 'Upload Inventory to Azure Blob Storage'
  inputs:
    azureSubscription: $(azureSubscription)
    ScriptPath: '$(Build.SourcesDirectory)/Scripts/upload_to_blob.ps1'
    ScriptArguments: '-resourceGroup "${{parameters.resourcegroup}}" -containerName "$(storageContainerName)" -blobName "$(parameters.ContainerFolder)/Resources_${{parameters.resourcegroup}}.csv" -storageAccountName "$(storageAccountName)" -storageAccountKey "$(storageAccountAccessKey)"'
    azurePowerShellVersion: LatestVersion

